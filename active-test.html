<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE Portal | Active Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root { 
            --primary-blue: #0b4a8f; 
            --bg-light: #f1f5f9; 
            --answered: #22c55e;
            --marked: #8b5cf6;
            --not-visited: #cbd5e1;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-light); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Header */
        header { background: #fff; padding: 15px 40px; border-bottom: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; height: 70px; }
        
        /* Main Layout */
        .test-wrapper { display: flex; flex: 1; overflow: hidden; }
        
        /* Left: Question Area */
        .question-section { flex: 1; display: flex; flex-direction: column; background: white; border-right: 1px solid #e2e8f0; }
        .q-header { padding: 15px 30px; border-bottom: 1px solid #f1f5f9; font-weight: 700; color: var(--primary-blue); }
        .q-content { padding: 40px; overflow-y: auto; flex: 1; }
        .option { display: block; padding: 15px 20px; border: 1px solid #e2e8f0; border-radius: 8px; margin-top: 12px; cursor: pointer; transition: 0.2s; }
        .option:hover { background: #f8fafc; border-color: var(--primary-blue); }
        .option.selected { background: #eff6ff; border-color: var(--primary-blue); font-weight: 600; }

        /* Right: Sidebar Palette */
        .palette-section { width: 320px; background: #fff; padding: 20px; display: flex; flex-direction: column; }
        .palette-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; overflow-y: auto; }
        .p-btn { height: 45px; border-radius: 4px; border: 1px solid #cbd5e1; background: #fff; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; }
        .p-btn.active { border: 2px solid var(--primary-blue); }
        .p-btn.answered { background: var(--answered); color: white; border-color: var(--answered); }
        .p-btn.visited { background: #ef4444; color: white; border-color: #ef4444; }

        /* Bottom: Nav Panel */
        .nav-panel { height: 80px; background: #fff; border-top: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; }
        .btn { padding: 10px 25px; border-radius: 4px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-save { background: var(--answered); color: white; }
        .btn-clear { background: #f1f5f9; color: #475569; }
        .btn-submit { background: var(--primary-blue); color: white; }
    </style>
</head>
<body>

<header>
    <div><h3 id="displayTestName">JEE Practice Test</h3></div>
    <div style="text-align: right;">
        <span id="timer" style="font-size: 1.2rem; font-weight: 800; color: #ef4444;">00:00:00</span>
    </div>
</header>

<div class="test-wrapper">
    <div class="question-section">
        <div class="q-header" id="qNumHeader">Question No. 1</div>
        <div class="q-content" id="qContent">
            <p>Loading your test, please wait...</p>
        </div>
        <div class="nav-panel">
            <div>
                <button class="btn btn-clear" onclick="clearResponse()">Clear Response</button>
            </div>
            <div>
                <button class="btn btn-outline" style="margin-right:10px;" onclick="prevQuestion()">Previous</button>
                <button class="btn btn-save" onclick="nextQuestion()">Save & Next</button>
                <button class="btn btn-submit" style="margin-left: 20px; background: #d946ef;" onclick="submitTest()">Final Submit</button>
            </div>
        </div>
    </div>

    <div class="palette-section">
        <h4 style="margin-bottom: 15px; color: #475569;">Question Palette</h4>
        <div class="palette-grid" id="paletteGrid">
            </div>
        <div style="margin-top: auto; border-top: 1px solid #e2e8f0; padding-top: 15px;">
            <div style="font-size: 0.8rem; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <span><span style="display:inline-block;width:12px;height:12px;background:#22c55e;"></span> Answered</span>
                <span><span style="display:inline-block;width:12px;height:12px;background:#ef4444;"></span> Not Answered</span>
                <span><span style="display:inline-block;width:12px;height:12px;background:#fff;border:1px solid #ccc;"></span> Not Visited</span>
            </div>
        </div>
    </div>
</div>

<script>
    const supabaseUrl = 'https://ijxsnunkfhudwnkrwmzk.supabase.co';
    const supabaseKey = 'sb_publishable_V-KT1zvp-73dqHHvmx3fNA_iHw53TCl'; 
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let questions = [];
    let currentIdx = 0;
    let userAnswers = [];
    let visited = [];
    const testName = localStorage.getItem('currentTestName');

    async function loadTest() {
        const { data, error } = await supabaseClient.from('questions_table').select('*').eq('test_name', testName).single();
        if (data) {
            questions = data.question_data;
            userAnswers = new Array(questions.length).fill(null);
            visited = new Array(questions.length).fill(false);
            initPalette();
            renderQuestion();
        }
    }

    function initPalette() {
        const grid = document.getElementById('paletteGrid');
        grid.innerHTML = '';
        questions.forEach((_, i) => {
            const btn = document.createElement('button');
            btn.className = 'p-btn';
            btn.id = `pal-${i}`;
            btn.innerText = i + 1;
            btn.onclick = () => jumpTo(i);
            grid.appendChild(btn);
        });
    }

    function renderQuestion() {
        visited[currentIdx] = true;
        const q = questions[currentIdx];
        document.getElementById('qNumHeader').innerText = `Question No. ${currentIdx + 1}`;
        document.getElementById('qContent').innerHTML = `
            <div style="font-size: 1.25rem; line-height: 1.6; margin-bottom: 30px;">${q.q}</div>
            <div id="options">
                ${q.options.map((opt, i) => `
                    <div class="option ${userAnswers[currentIdx] === i ? 'selected' : ''}" onclick="selectOption(${i})">
                        <strong>${String.fromCharCode(65+i)}.</strong> ${opt}
                    </div>
                `).join('')}
            </div>
        `;
        updatePaletteUI();
        if(window.MathJax) MathJax.typesetPromise();
    }

    function selectOption(i) {
        userAnswers[currentIdx] = i;
        renderQuestion();
    }

    function clearResponse() {
        userAnswers[currentIdx] = null;
        renderQuestion();
    }

    function updatePaletteUI() {
        questions.forEach((_, i) => {
            const btn = document.getElementById(`pal-${i}`);
            btn.classList.remove('active', 'answered', 'visited');
            if (i === currentIdx) btn.classList.add('active');
            if (userAnswers[i] !== null) btn.classList.add('answered');
            else if (visited[i]) btn.classList.add('visited');
        });
    }

    function jumpTo(i) { currentIdx = i; renderQuestion(); }
    function prevQuestion() { if(currentIdx > 0) { currentIdx--; renderQuestion(); } }
    function nextQuestion() { 
        if(currentIdx < questions.length - 1) { currentIdx++; renderQuestion(); } 
    }

    async function submitTest() {
        if(!confirm("Are you sure you want to finish the test?")) return;
        const { data: { user } } = await supabaseClient.auth.getUser();
        let correct = 0;
        questions.forEach((q, i) => {
            const cIdx = q.options.findIndex(o => o.trim() === q.correct.trim());
            if(userAnswers[i] === cIdx) correct++;
        });

        const { error } = await supabaseClient.from('student_progress').insert([{
            student_id: user.id,
            username: user.email.split('@')[0],
            test_name: testName,
            score: `${correct}/${questions.length}`,
            user_answers: userAnswers,
            accuracy: Math.round((correct/questions.length)*100)
        }]);

        if(!error) window.location.href = 'performance.html';
        else alert("Submit failed: " + error.message);
    }

    loadTest();
</script>
</body>
</html>
