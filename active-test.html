<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE Portal | Elite Exam Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
            --navy: #0f172a;
            --navy-hover: #1e293b;
            --grey-btn: #f1f5f9; /* LIGHT GREY */
            --grey-hover: #e2e8f0;
            --correct: #10b981;
            --purple: #8b5cf6;
            --accent-blue: #3b82f6;
            --thin-line: #e2e8f0; 
        }

        /* Full-Screen Loading Guard */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at top left, #e0e7ff, #f8fafc);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 9999; transition: opacity 0.5s ease;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--grey-hover);
            border-top: 4px solid var(--accent-blue); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        @keyframes slideInRight { from { transform: translateX(30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .slide-right { animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .slide-left { animation: slideInLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: radial-gradient(circle at top left, #e0e7ff, #f8fafc);
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        header {
            background: var(--glass); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 15px 50px; display: flex; justify-content: space-between; align-items: center;
        }

        .header-right { display: flex; align-items: center; gap: 25px; }
        #syncStatus { font-size: 0.7rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; }

        .main-layout { display: flex; flex: 1; padding: 25px; gap: 25px; overflow: hidden; align-items: stretch; }

        .test-engine {
            flex: 1; background: var(--glass); backdrop-filter: blur(25px);
            border-radius: 30px; border: 1px solid var(--glass-border);
            display: flex; flex-direction: column; overflow: hidden;
        }

        .q-scroll-area { padding: 50px 40px 40px 40px; flex: 1; overflow-y: auto; overflow-x: hidden; }

        .question-sub-card {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 25px;
        }

        .option-sub-card {
            background: white; padding: 20px 25px; border-radius: 15px;
            margin-bottom: 12px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent; display: flex; align-items: center; gap: 15px;
        }
        .option-sub-card:hover { transform: translateY(-3px); border-color: var(--grey-hover); box-shadow: 0 10px 20px rgba(0,0,0,0.06); }
        .option-sub-card.selected { border-color: var(--accent-blue); background: #f8faff; }

        .radio-btn { width: 20px; height: 20px; border: 2px solid #cbd5e1; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: border-color 0.2s; }
        .selected .radio-btn { border-color: var(--accent-blue); }
        .radio-inner { width: 10px; height: 10px; border-radius: 50%; background: var(--accent-blue); display: none; }
        .selected .radio-inner { display: block; }

        .palette-card { width: 350px; background: var(--glass); backdrop-filter: blur(25px); border-radius: 30px; border: 1px solid var(--glass-border); display: flex; flex-direction: column; }
        .palette-header { padding: 30px 25px 15px 25px; }
        .palette-grid { padding: 10px 25px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; flex: 1; overflow-y: auto; align-content: start; }

        .footer-nav, .legend-section { height: 90px; border-top: 1px solid var(--thin-line); display: flex; align-items: center; }
        .footer-nav { padding: 0 40px; justify-content: space-between; }
        .legend-section { padding: 0 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.75rem; font-weight: 500; color: #64748b; }

        .btn { 
            padding: 12px 24px; border-radius: 12px; border: none; font-weight: 600; 
            cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            font-size: 0.85rem; display: flex; align-items: center; gap: 8px; 
        }
        .btn-grey { background: var(--grey-btn); color: #475569; }
        .btn-grey:hover { background: var(--grey-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .btn-finish { background: var(--navy); color: white; padding: 12px 35px; }
        .btn-finish:hover { background: var(--navy-hover); transform: translateY(-2px); box-shadow: 0 8px 20px rgba(15, 23, 42, 0.3); }

        #timer { font-size: 1.6rem; font-weight: 800; color: var(--navy); font-variant-numeric: tabular-nums; }
        
        /* THE CIRCLE STYLES YOU REQUESTED */
        .p-circle { 
            aspect-ratio: 1/1; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-weight: 600; cursor: pointer; 
            background: var(--grey-btn); /* DEFAULT LIGHT GREY */
            color: #64748b; font-size: 0.85rem; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 2px solid transparent; margin: 3px; 
        }
        /* Hover: Blue border appears, bg shifts to white */
        .p-circle:hover { border-color: var(--accent-blue); transform: scale(1.15); background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        
        /* Active: Blue Border Pulse + Light Grey Background */
        .p-circle.active { 
            border: 3px solid var(--accent-blue) !important; 
            background: var(--grey-btn) !important; 
            color: var(--accent-blue); 
            transform: scale(1.05); 
            animation: pulse-blue 2s infinite; 
        }
        
        /* Status Colors (Overrides the Grey) */
        .p-circle.answered { background: var(--correct) !important; color: white; border-color: transparent; }
        .p-circle.marked { background: var(--purple) !important; color: white; border-color: transparent; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <p style="font-weight: 600; color: var(--navy); letter-spacing: 1px;">SYNCING SECURE CONNECTION...</p>
</div>

<header>
    <h2 id="testTitle" style="color: var(--navy); font-weight: 700;">--</h2>
    <div class="header-right">
        <div id="syncStatus">● Synced</div>
        <div id="timer">40:00</div>
    </div>
</header>

<div class="main-layout">
    <div class="test-engine">
        <div class="q-scroll-area" id="questionArea">
            <p id="qLabel" style="color: var(--accent-blue); font-weight: 800; font-size: 0.7rem; margin-bottom: 12px; letter-spacing: 2px;">QUESTION 1</p>
            <div class="question-sub-card"><div id="qText" style="font-size: 1.35rem; color: #1e293b; line-height: 1.5; font-weight: 500;">...</div></div>
            <div id="optionsContainer"></div>
        </div>
        <div class="footer-nav">
            <div style="display:flex; gap:10px;">
                <button class="btn btn-grey" onclick="changeQ(-1)">&larr; Previous</button>
                <button class="btn btn-grey" onclick="clearAns()">Clear</button>
                <button class="btn btn-grey" onclick="markReview()">Review</button>
                <button class="btn btn-grey" onclick="changeQ(1)">Next &rarr;</button>
            </div>
            <button class="btn btn-finish" onclick="finalSubmit()">Finish Test</button>
        </div>
    </div>
    <div class="palette-card">
        <div class="palette-header"><h3 style="font-size: 1.1rem; color: var(--navy); border-bottom: 2px solid #f1f5f9; padding-bottom: 12px; font-weight: 700;">Question Palette</h3></div>
        <div class="palette-grid" id="paletteGrid"></div>
        <div class="legend-section">
            <div style="display:flex; align-items:center; gap:6px;"><span style="width:8px;height:8px;border-radius:50%;background:var(--correct)"></span> Answered</div>
            <div style="display:flex; align-items:center; gap:6px;"><span style="width:8px;height:8px;border-radius:50%;background:var(--purple)"></span> Review</div>
            <div style="display:flex; align-items:center; gap:8px;"><span style="width:8px;height:8px;border-radius:50%;background:var(--grey-btn)"></span> Unanswered</div>
        </div>
    </div>
</div>

<script>
    const supabaseUrl = 'https://ijxsnunkfhudwnkrwmzk.supabase.co';
    const supabaseKey = 'sb_publishable_V-KT1zvp-73dqHHvmx3fNA_iHw53TCl'; 
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let questions = []; let currentIdx = 0; let userAnswers = []; let marked = []; let timeLeft = 2400; let recordId = null; 
    const testName = localStorage.getItem('currentTestName');
    const subjectName = localStorage.getItem('currentSubjectName').charAt(0).toUpperCase() + localStorage.getItem('currentSubjectName').slice(1);

    async function start() {
        try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) { window.location.href = 'login.html'; return; }
            const username = user.email;

            const { data: qData } = await supabaseClient.from('questions_table').select('*').eq('test_name', testName).eq('subject', subjectName); // Double filtering for accuracy;
            if (!qData || qData.length === 0) return;
            questions = qData[0].question_data;
            document.getElementById('testTitle').innerText = testName;

            const { data: existingRecords } = await supabaseClient.from('student_progress').select('*').eq('username', username).eq('test_name', testName).eq('subject', subjectName);

            if (existingRecords && existingRecords.length > 0) {
                const record = existingRecords[0];
                if (record.is_finished === true) { window.location.href = 'performance.html'; return; }
                recordId = record.id;
                
                // DATA SANITIZATION: Force answers into an array to avoid the "Object" bug
                let rawAns = record.user_answers;
                userAnswers = Array.isArray(rawAns) ? rawAns : new Array(questions.length).fill(null);
                
                let rawMarked = record.marked_for_review;
                marked = Array.isArray(rawMarked) ? rawMarked : new Array(questions.length).fill(false);
                
                currentIdx = record.current_index || 0;
                const startAt = new Date(record.updated_at).getTime();
                timeLeft = Math.max(0, 2400 - Math.floor((new Date().getTime() - startAt) / 1000));
            } else {
                userAnswers = new Array(questions.length).fill(null); 
                marked = new Array(questions.length).fill(false);
                const { data: newRec } = await supabaseClient.from('student_progress').insert([{ 
                    student_id: user.id, username: username, subject: testName, test_name: testName,
                    current_index: 0, user_answers: userAnswers, marked_for_review: marked, is_finished: false
                }]).select();
                if (newRec) recordId = newRec[0].id;
            }
            setupPalette(); render(); runTimer();
            document.getElementById('loadingOverlay').style.opacity = '0';
            setTimeout(() => { document.getElementById('loadingOverlay').style.display = 'none'; }, 500);
        } catch (e) { alert("Session Expired or Connection Failed."); }
    }

    async function autoSave() {
        if (!recordId) return;
        document.getElementById('syncStatus').innerText = "● Syncing...";
        await supabaseClient.from('student_progress').update({ 
            user_answers: userAnswers, marked_for_review: marked, current_index: currentIdx, updated_at: new Date()
        }).eq('id', recordId);
        document.getElementById('syncStatus').innerText = "● Synced";
    }

    function setupPalette() {
        const grid = document.getElementById('paletteGrid'); grid.innerHTML = '';
        questions.forEach((_, i) => {
            const c = document.createElement('div'); c.className = 'p-circle'; c.id = `pc-${i}`; c.innerText = i + 1;
            c.onclick = () => { const dir = i > currentIdx ? 'slide-right' : 'slide-left'; currentIdx = i; render(dir); autoSave(); };
            grid.appendChild(c);
        });
    }

    function render(anim = '') {
        const q = questions[currentIdx]; const area = document.getElementById('questionArea');
        area.classList.remove('slide-right', 'slide-left');
        if(anim) { void area.offsetWidth; area.classList.add(anim); }
        document.getElementById('qLabel').innerText = `QUESTION ${currentIdx + 1}`;
        document.getElementById('qText').innerText = q.q;
        document.getElementById('optionsContainer').innerHTML = q.options.map((opt, i) => `
            <div class="option-sub-card ${userAnswers[currentIdx] === i ? 'selected' : ''}" onclick="select(${i})">
                <div class="radio-btn"><div class="radio-inner"></div></div>
                <span style="font-weight:700; color:var(--accent-blue); min-width: 20px;">${String.fromCharCode(65+i)}.</span> 
                <span style="color: #334155; font-weight: 500;">${opt}</span>
            </div>
        `).join('');
        updatePaletteUI(); if(window.MathJax) MathJax.typesetPromise();
    }

    function select(i) { userAnswers[currentIdx] = i; render(); autoSave(); }
    function clearAns() { userAnswers[currentIdx] = null; render(); autoSave(); }
    function markReview() { marked[currentIdx] = !marked[currentIdx]; render(); autoSave(); }
    function changeQ(step) {
        let next = currentIdx + step;
        if(next >= 0 && next < questions.length) { const anim = step > 0 ? 'slide-right' : 'slide-left'; currentIdx = next; render(anim); autoSave(); }
    }

    function updatePaletteUI() {
        questions.forEach((_, i) => {
            const el = document.getElementById(`pc-${i}`); if(!el) return;
            el.className = 'p-circle';
            
            // Priority Check
            if(i === currentIdx) el.classList.add('active');
            
            if(marked[i]) {
                el.classList.add('marked');
            } else if(userAnswers[i] !== null && userAnswers[i] !== undefined && typeof userAnswers[i] === 'number') {
                el.classList.add('answered');
            }
        });
    }

    function runTimer() {
        const el = document.getElementById('timer');
        const itv = setInterval(() => {
            if(timeLeft <= 0) { clearInterval(itv); finalSubmit(true); return; }
            let m = Math.floor(timeLeft / 60); let s = timeLeft % 60;
            el.innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            timeLeft--;
            updateTimerText(el);
        }, 1000);
    }

    // Helper to keep the interval clean
    function updateTimerText(el) {
        let m = Math.floor(timeLeft / 60); 
        let s = timeLeft % 60;
        el.innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    async function finalSubmit() {
        // 1. Get current test details
        const testName = document.getElementById('testTitle').innerText;
        const username = localStorage.getItem('userEmail');

        // 2. Update the database
        const { error } = await supabaseClient
            .from('student_progress')
            .update({ 
                is_finished: true, 
                status: 'completed' // Updating status to completed as well
            })
            .eq('test_name', testName)
            .eq('subject', subjectName) // Double filtering for accuracy
            .eq('username', username);
    
        if (error) {
            console.error('Error finishing test:', error);
            alert('Failed to submit test. Please try again.');
        } else {
            // 3. Redirect to results or tests page
            window.location.href = 'tests.html';
        }
    }

    start();
</script>
</body>
</html>
